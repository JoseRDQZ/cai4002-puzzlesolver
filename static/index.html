<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>8-Piece Puzzle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --tile: 120px; --board: calc(var(--tile) * 3); }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      display: grid; place-items: start center;
      min-height: 100vh; margin: 0; padding: 32px 16px;
    }
    h1 { margin: 0 0 16px; }
    .controls { margin: 8px 0 24px; }
    .board {
      width: var(--board); height: var(--board);
      display: grid;
      grid-template-columns: repeat(3, var(--tile));
      grid-auto-rows: var(--tile);
      gap: 0; /* no gaps */
      border: 2px solid #333;
      background: #eee;
    }
    .tile {
      display: grid; place-items: center;
      font-size: 28px; font-weight: 600; color: #111;
      background: #e9e9e9;
      border: 1px solid #333; /* thin grid lines */
      user-select: none;
      background-size: cover; background-position: center;
      cursor: pointer;
    }
    .blank {
      background: #cfcfcf !important;
      color: transparent;
      cursor: default;
    }
    .with-image { color: transparent; } /* hide numbers when image slices in use */
    button {
      padding: 8px 14px; margin: 0 6px;
      border-radius: 6px; border: 1px solid #999;
      background: #f5f5f5; cursor: pointer;
    }
    button:hover { background: #ededed; }
    .hint { font-size: 12px; color: #666; margin-top: 6px; }
    canvas { display: none; }
  </style>
</head>
<body>
  <main>
    <h1>8-Piece Puzzle</h1>

    <div class="controls">
      <input id="file" type="file" accept="image/*" />
      <div class="hint">Pick an image â€” it auto-crops to a centered square and fills the tiles.</div>
    </div>

    <div id="board" class="board" aria-label="8-Puzzle board"></div>

    <div class="controls">
      <button id="shuffleBtn">Shuffle</button>
      <button id="solveBtn">Auto Solve</button>
    </div>
  </main>

  <canvas id="work"></canvas>

  <script>
    const boardEl   = document.getElementById('board');
    const fileInput = document.getElementById('file');
    const work      = document.getElementById('work');
    const wctx      = work.getContext('2d');

    let state = [1,2,3,4,5,6,7,8,0];
    let slices = Array(9).fill(null);
    const usingImage = () => slices.some((d, i) => i < 8 && d);

    function renderBoard(arr) {
      boardEl.replaceChildren();
      for (let i = 0; i < 9; i++) {
        const v = arr[i];
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.dataset.index = i;

        if (v === 0) {
          tile.classList.add('blank');
        } else {
          tile.textContent = String(v);
        }

        if (usingImage()) {
          tile.classList.add('with-image');
          if (v !== 0) {
            const dataURL = slices[v - 1];
            if (dataURL) tile.style.backgroundImage = `url(${dataURL})`;
          }
        }

        // Add click to move
        tile.addEventListener('click', () => handleMove(i));

        boardEl.appendChild(tile);
      }
    }

    function handleMove(i) {
      const blankIndex = state.indexOf(0);
      const row = Math.floor(i / 3), col = i % 3;
      const brow = Math.floor(blankIndex / 3), bcol = blankIndex % 3;

      const isNeighbor = (Math.abs(row - brow) + Math.abs(col - bcol)) === 1;
      if (!isNeighbor) return;

      // Swap tile with blank
      [state[i], state[blankIndex]] = [state[blankIndex], state[i]];
      renderBoard(state);
    }

    // ====== IMAGE HANDLING ======
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const img = new Image();
      img.onload = () => {
        const size = Math.min(img.naturalWidth, img.naturalHeight);
        const sx = Math.floor((img.naturalWidth  - size) / 2);
        const sy = Math.floor((img.naturalHeight - size) / 2);

        const BOARD_PX = 600;
        work.width = BOARD_PX; work.height = BOARD_PX;
        wctx.clearRect(0,0,BOARD_PX,BOARD_PX);
        wctx.drawImage(img, sx, sy, size, size, 0, 0, BOARD_PX, BOARD_PX);

        const tileSize = BOARD_PX / 3;
        slices = Array(9).fill(null);

        for (let r = 0; r < 3; r++) {
          for (let c = 0; c < 3; c++) {
            const idx = r * 3 + c;
            if (idx === 8) continue;
            const piece = document.createElement('canvas');
            piece.width = tileSize; piece.height = tileSize;
            const pctx = piece.getContext('2d');
            pctx.drawImage(work, c * tileSize, r * tileSize, tileSize, tileSize, 0, 0, tileSize, tileSize);
            slices[idx] = piece.toDataURL('image/png');
          }
        }
        renderBoard(state);
      };
      img.onerror = () => alert('Could not load image.');
      img.src = URL.createObjectURL(file);
    });

    // ====== BACKEND ======
    async function apiShuffle() {
      const res = await fetch('/shuffle');
      if (!res.ok) throw new Error('Shuffle failed');
      return (await res.json()).state;
    }

    async function apiSolve(start) {
      const body = { start, algo: "astar", heuristic: "manhattan", depth_limit: 50 };
      const res = await fetch('/solve', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error('Solve failed');
      return res.json();
    }

    document.getElementById('shuffleBtn').addEventListener('click', async () => {
      try {
        state = await apiShuffle();
        renderBoard(state);
      } catch (e) {
        console.error(e);
        alert('Shuffle failed. Check the server log.');
      }
    });

    document.getElementById('solveBtn').addEventListener('click', async () => {
      try {
        const result = await apiSolve(state);
        const seq = result.states || [];
        let i = 0;
        const tick = () => {
          if (i >= seq.length) return;
          state = seq[i++];
          renderBoard(state);
          setTimeout(tick, 220);
        };
        tick();
      } catch (e) {
        console.error(e);
        alert('Solve failed. Check the server log.');
      }
    });

    renderBoard(state);
  </script>
</body>
</html>
